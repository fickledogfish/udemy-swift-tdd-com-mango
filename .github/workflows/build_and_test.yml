name: Build and test the app

on: [ push, pull_request ]

jobs:
  build:
    name: Build and test
    runs-on: macos-latest

    env:
      PROJECT_TYPE: project
      PROJECT_FILE: CleanApp/CleanApp.xcodeproj

      PLATFORM: ${{ 'iOS Simulator' }}
      DEVICE: ${{ 'iPhone 13' }}

      CI_SCHEME: "CI"
      INTEGRATION_SCHEME: "UseCasesIntegrationTests"

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build
        run: >
          xcodebuild
          -"$PROJECT_TYPE" "$PROJECT_FILE"
          -scheme "$CI_SCHEME"
          -destination "platform=$PLATFORM,name=$DEVICE"
          build-for-testing

      - name: Lint
        run: swiftlint

      - name: Run CI tests
        run: >
          xcodebuild
          -"$PROJECT_TYPE" "$PROJECT_FILE" 
          -scheme "$CI_SCHEME"
          -destination "platform=$PLATFORM,name=$DEVICE"
          test-without-building

      - name: Build integration tests
        run: >
          xcodebuild
          -"$PROJECT_TYPE" "$PROJECT_FILE"
          -scheme "$INTEGRATION_SCHEME"
          -destination "platform=$PLATFORM,name=$DEVICE"
          build-for-testing

      - name: Run integration tests
        continue-on-error: true
        run: >
          xcodebuild
          -"$PROJECT_TYPE" "$PROJECT_FILE"
          -scheme "$INTEGRATION_SCHEME"
          -destination "platform=$PLATFORM,name=$DEVICE"
          test-without-building
